---
title: "AzureDNS"
linkTitle: "AzureDNS"
weight: 30
type: "docs"
---

To configure the AzureDNS DNS01 Challenge in a Kubernetes cluster there are 2 ways:
- A Managed Identity
- Service Principal

## Managed Identity

- First of all we need to create the identity in Azure Cloud (the below code is Terraform, but this action can be performed also with `azure-cli`)

> The resource group must be already existing in order for this to work.
> This role allows `cert-manager` to control `AzureDNS` zones in the same resource group as the identity lives in

```terraform
variable "cluster_name" {
  type = string
}
variable resource_group_name {}
variable resource_group_id {}
variable location {}

output client_id {
  value = azurerm_user_assigned_identity.main.client_id
}

resource "azurerm_user_assigned_identity" "main" {
  name                = "${var.cluster_name}-cert-manager"
  resource_group_name = var.resource_group_name
  location            = var.location
}

resource "azurerm_role_definition" "main" {
  name        = "${var.cluster_name}-cert-manager"
  scope       = var.resource_group_id
  description = "This role is used by cert-manager"

  permissions {
    actions = [
      "Microsoft.Network/dnsZones/*/read",
      "Microsoft.Network/dnsZones/*/write",
      "Microsoft.Network/dnsZones/*/delete",
      "Microsoft.Network/dnsZones/read",
    ]
  }
  assignable_scopes = [
    var.resource_group_id
  ]
}

resource "azurerm_role_assignment" "main" {
  scope              = var.resource_group_id
  role_definition_id = azurerm_role_definition.main.id
  principal_id       = azurerm_user_assigned_identity.main.principal_id
}
```

> and obtain the `client_id` from the identity just created

- Install https://github.com/Azure/aad-pod-identity and make sure it's working properly

- in the namespace where `cert-manager` will be installed please add these two Kubernetes resources 

> to obtain `subcription_id` please use `az account show` command line tool

```yaml
apiVersion: aadpodidentity.k8s.io/v1
kind: AzureIdentity
metadata:
  annotations:
    aadpodidentity.k8s.io/Behavior: namespaced
  name: cert-manager
  namespace: cert-manager
spec:
  ClientID: <client_id>
  ResourceID: /subscriptions/<subscription_id>/resourcegroups/<resource_group_name>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<identity_name>
  type: 0
---
apiVersion: aadpodidentity.k8s.io/v1
kind: AzureIdentityBinding
metadata:
  name: cert-manager
  namespace: cert-manager
spec:
  AzureIdentity: cert-manager
  Selector: cert-manager
```

- Add `aadpodidbinding: cert-manager` label to cert-manager controller pod
`kubectl label deployment cert-manager -n cert-manager aadpodidbinding=cert-manager`

- Create `Issuer/ClusterIssuer` without `clientID`, `clientSecretSecretRef` and `tenantID`

```yaml
apiVersion: cert-manager.io/v1alpha2
kind: Issuer
metadata:
  name: example-issuer
spec:
  acme:
    ...
    solvers:
    - dns01:
        azuredns:
          subscriptionID: <subscription_id>
          resourceGroupName: <resource_group_name>
          hostedZoneName: AZURE_DNS_ZONE
```

## Service Principal
Configuring the AzureDNS DNS01 Challenge for a Kubernetes cluster requires
creating a service principal in Azure.

To create the service principal you can use the following script (requires
`azure-cli` and `jq`):

```bash
# Choose a name for the service principal that contacts azure DNS to present the challenge
$ AZURE_CERT_MANAGER_NEW_SP_NAME=NEW_SERVICE_PRINCIPAL_NAME
# This is the name of the resource group that you have your dns zone in
$ AZURE_DNS_ZONE_RESOURCE_GROUP=AZURE_DNS_ZONE_RESOURCE_GROUP
# The DNS zone name. It should be something like domain.com or sub.domain.com
$ AZURE_DNS_ZONE=AZURE_DNS_ZONE

$ DNS_SP=$(az ad sp create-for-rbac --name $AZURE_CERT_MANAGER_NEW_SP_NAME)
$ AZURE_CERT_MANAGER_SP_APP_ID=$(echo $DNS_SP | jq -r '.appId')
$ AZURE_CERT_MANAGER_SP_PASSWORD=$(echo $DNS_SP | jq -r '.password')
$ AZURE_TENANT_ID=$(echo $DNS_SP | jq -r '.tenant')
$ AZURE_SUBSCRIPTION_ID=$(az account show | jq -r '.id')
```

For security purposes, it is appropriate to utilize RBAC to ensure that you
properly maintain access control to your resources in Azure. The service
principal that is generated by this tutorial has fine grained access to ONLY the
DNS Zone in the specific resource group specified. It requires this permission
so that it can read/write the \_acme\_challenge TXT records to the zone.

Lower the Permissions of the service principal.
```bash
$ az role assignment delete --assignee $AZURE_CERT_MANAGER_SP_APP_ID --role Contributor
```

Give Access to DNS Zone.
```bash
$ DNS_ID=$(az network dns zone show --name $AZURE_DNS_ZONE --resource-group $AZURE_DNS_ZONE_RESOURCE_GROUP --query "id" --output tsv)
$ az role assignment create --assignee $AZURE_CERT_MANAGER_SP_APP_ID --role "DNS Zone Contributor" --scope $DNS_ID
```

Check Permissions. As the result of the following command, we would like to see just one object in the permissions array with "DNS Zone Contributor" role.
```bash
$ az role assignment list --all --assignee $AZURE_CERT_MANAGER_SP_APP_ID
```

A secret containing service principal password should be created on Kubernetes to facilitate presenting the challenge to Azure DNS. You can create the secret with the following command:
```bash
$ kubectl create secret generic azuredns-config --from-literal=client-secret=$AZURE_CERT_MANAGER_SP_PASSWORD
```

Get the variables for configuring the issuer.
```bash
$ echo "AZURE_CERT_MANAGER_SP_APP_ID: $AZURE_CERT_MANAGER_SP_APP_ID"
$ echo "AZURE_CERT_MANAGER_SP_PASSWORD: $AZURE_CERT_MANAGER_SP_PASSWORD"
$ echo "AZURE_SUBSCRIPTION_ID: $AZURE_SUBSCRIPTION_ID"
$ echo "AZURE_TENANT_ID: $AZURE_TENANT_ID"
$ echo "AZURE_DNS_ZONE: $AZURE_DNS_ZONE"
$ echo "AZURE_DNS_ZONE_RESOURCE_GROUP: $AZURE_DNS_ZONE_RESOURCE_GROUP"
```

To configure the issuer, substitute the capital cased variables with the values from the previous script.

```yaml
apiVersion: cert-manager.io/v1alpha2
kind: Issuer
metadata:
  name: example-issuer
spec:
  acme:
    ...
    solvers:
    - dns01:
        azuredns:
          clientID: AZURE_CERT_MANAGER_SP_APP_ID
          clientSecretSecretRef:
          # The following is the secret we created in Kubernetes. Issuer will use this to present challenge to Azure DNS.
            name: azuredns-config
            key: client-secret
          subscriptionID: AZURE_SUBSCRIPTION_ID
          tenantID: AZURE_TENANT_ID
          resourceGroupName: AZURE_DNS_ZONE_RESOURCE_GROUP
          hostedZoneName: AZURE_DNS_ZONE
          # Azure Cloud Environment, default to AzurePublicCloud
          environment: AzurePublicCloud
```
